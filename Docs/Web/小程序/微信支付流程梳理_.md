较为常用（小程序， h5），这里总结一篇文档方便后项目维护~~~<br />关于微信支付的东西，微信的[官方文档](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_3.shtml)已经写得很明白了，这里只是针对项目做一个简单的说明和总结。<br />好慧赔项目中用到的支付，主要涉及**两个模块三种情况**，**h5支付（浏览器支付，微信浏览器支付）和小程序支付**，相对来说小程序支付实操起来会更简单一些，h5支付因为在非微信环境下，故需要引入微信提供的jssdk脚本让h5项目也可以调用一些微信的开放api（其中就包含了微信支付等功能）。

那么问题来了，微信支付什么流程，怎么实现的？上文档！**（**[https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_4](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_4)**）😁，**文档看起来虽然很复杂但是仔细看还是看的明白的，其实主要流程微信已经帮忙总结好了，大概就下面这几个流程**：**<br />

**商户系统和微信支付系统主要交互：**

1、商户server调用统一下单接口请求订单，api参见公共api【[统一下单API](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1)】----》**下单**<br />2、商户server可通过【[JSAPI调起支付API](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=7_7&index=6)】调起微信支付，发起支付请求。-----》**支付**<br />3、商户server接收支付通知，api参见公共api【[支付结果通知API](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_7)】--------------》**修改订单支付状态（主要是后端的事儿）**<br />4、商户server查询支付结果，api参见公共api【[查询订单API](https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_2)】 ------------------》 **订单查询

具体是怎么实现的呢？**<br />  关于微信支付的一些资料的准备和账号申请配置不做过多赘述，详情仔细翻阅官方文档即可

- 前期准备：[https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_6_1.shtml](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_6_1.shtml)
- 开发文档：[https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_6_2.shtml](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_6_2.shtml)



<a name="5wZ9E"></a>

### 一、H5支付流程（[浏览器支付](https://pay.weixin.qq.com/wiki/doc/api/H5.php?chapter=15_4)注意第三步）：
![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614670559923-a851ec36-dcd3-41c6-a22a-3ff3a913e9ef.png)<br />具体的业务实现：    

1. **前端调用接口创建订单，生成订单id**<br />![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614670725497-46d096ec-671f-4fcf-b72c-a6851daf5524.png)
1. 获取到订单id之后，调用微信支付接口（这里的微信支付是由后端发起的，前端仅传参数给后端，参数如下图，订单ID，金额，支付状态等等）<br />![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614670909687-c49c2a25-ccb0-45be-97d9-1a50f83d3e90.png)
1. 后端发起请求，获取**mweb_url**，**前端重定向到该地址，并唤起微信支付，发起微信支付流程    **

![](https://raw.githubusercontent.com/JuntengMa/image/0b2bbe4b0ef19a002cf0b564f581dae701106d64/1614673719886-ba692c90-45d6-4f5b-93ea-afaf94ba9d45.png)

![](https://raw.githubusercontent.com/JuntengMa/image/master/1614671482174-9b5e4abd-67b3-4067-a8d2-1d14d553901c.gif)

4. 支付完成（取消支付）<br />支付完成后，后端会受到微信给到的回调，修改数据库支付状态，流程结束<br />若用户取消支付，订单状态则一直为未支付状态，不做改变<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1451656/1614673343470-49c6fe04-a164-4c48-ab48-66b83b1bbbd6.png)
4. 代码实现：
   1. 创建订单，触发微信支付

![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614673343470-49c6fe04-a164-4c48-ab48-66b83b1bbbd6.png)

   1. 调用支付接口

![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614673447779-592027e5-5ef6-4b7e-a2f0-9042bab1796e.png)
<a name="pDH1h"></a>

### 二、微信浏览器支付

<br />微信开放了[jssdk脚本](https://pay.weixin.qq.com/wiki/doc/api/jsapi_sl.php?chapter=7_7&index=6)，前端项目引入之后，即可使用微信的一些开放能力，如微信分享，支付，文件上传等功能，详见h5项目utils/wechat/wechat.util.js 文件 ， 核心代码如下：<br />![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614674039500-947921e3-d490-4e8e-8da5-42aa9da50c0c.png)<br />如图所见，想要使用JS-SDK唤起微信支付必须先注入配置信息，这些配置信息由后端通过[签名算法](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#62)来生成，如果参数都没问题的话则唤起微信支付，支付完成之后的流程与浏览器支付相同（支付成功微信给到回调给后端修改订单状态)<br />**代码实现：**

   1. **生成订单**

![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614674554968-7a415580-3d00-4406-8491-934fb9cf3542.png)

   1. **获取配置信息**

![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614674590044-7c3a4730-9016-4f0f-8424-069e317fbeb5.png)

   1. **唤起支付**

![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614674788385-95c74bc2-950a-451b-8514-297373e984e4.png)<br />

<a name="lY65a"></a>
### 三、小程序支付
小程序支付流程与上述流程基本一样，操作上更为简单一些，微信对于自家产品兼容还是相当nice的~<br />直接看代码即可

1. 生成订单<br />![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614675088664-e641c675-fa68-4529-9401-77e12e996b8e.png)
1. 获取支付配置项

![image.png](https://raw.githubusercontent.com/JuntengMa/image/master/1614675158521-5fa7d053-a489-41dc-8b28-f16ae0cc7180.png)

3. 唤起支付，支付完成后进行对应操作<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1451656/1614675196376-35245360-481c-4007-a48b-6b4ae3ad9290.png)
