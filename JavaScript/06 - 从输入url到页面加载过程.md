---
title: 从输入URL到页面加载发生了什么
coverWidth: 1200
coverHeight: 750
date: 2020-11-16
categories: JavaScript
tags: 从输入URL到页面加载发生了什么
top:
cover: https://images.unsplash.com/photo-1461730117549-4b30953f78a6?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjg5ODI0fQ&w=750&dpi=2
---
> <h4> 
>  从输入URL到页面加载发生了什么???
> </h4>

<!--more-->



总体来说分为以下几个过程:

- [01/ DNS解析](#01-dns解析)
  - [DNS解析过程](#dns解析过程)
- [02 /TCP连接](#02-tcp连接)
- [03 /发送HTTP请求](#03-发送http请求)
- [04 /服务器处理请求并返回HTTP报文](#04-服务器处理请求并返回http报文)
- [05 /浏览器解析渲染页面](#05-浏览器解析渲染页面)

### 01/ DNS解析
DNS解析的过程就是在寻找哪台机器上有你需要的资源的全过程.
当你在浏览器中输入一个地址时,将网址转换为IP的过程叫做DNS解析

#### DNS解析过程
DNS解析本质上是一个递归查询的过程

![](https://s3.ax1x.com/2020/11/16/DAFZeU.png)

上图是查找`www.google.com`这个网址的过程
1. 在`本地域名服务器`中查询IP地址-->无
2. `本地域名服务器`向`根域名服务器`发送请求-->无
3. `本地域名服务器` 向`COM顶级域名服务器`发送请求-->无
4. ......
5. 最后本地服务器得到Google的IP的字号并缓存到本地,功下次使用

由上可以看出网址解析是一个 从右到左的过程:
`com` --> `google.com` --> `www.google.com`
根域名服务器呢?
默认情况下所有网址最后一位都是. , 即`www.google.com.`,方便用户一般都会省略,浏览器在请求DNS的时候会自动加上,
即NDS解析流程:
`.`-->`com.`-->`google.com.`-->`www.google.com.`

### 02 /TCP连接

HTTP协议是使用TCP作为其传输层协议的，当TCP出现瓶颈时，HTTP也会受到影响。

三次握手:

- 主机A向主机B发送TCP连接请求数据包
- 主机B收到请求后，会发回连接确认数据包。 
- 第三次，主机A收到主机B的确认报文后，还需作出确认，即发送一个序列号seq(A)=x+1；确认号为ack(A)=y+1的报文；

四次挥手:(假设主机A为客户端，主机B为服务器，其释放TCP连接的过程如下)

- 客户端向服务端发送关闭链接的请求
- 服务器收到请求之后,回复这个请求并确认
- 服务端也发送一个关闭链接的请求给客户端
- 客户端收到请求之后确认关闭然后断开tcp链接

### 03 /发送HTTP请求
- HTTP报文是包裹在tcp报文中发送的,服务端收到TCP报文时会解包提取出HTTP报文,但是该过程存在一定风险,HTTP报文是明文,如果中间被截取的话会存在一些信息泄露的风险
- HTTPS协议本质就是HTTP+SSL,在HTTP报文进入TCP报文之前,先使用SSL报文进行加密.从网络层的结构看它位于HTTP协议与TCP协议之间
  [![BunpMn.png](https://s1.ax1x.com/2020/10/26/BunpMn.png)](https://imgchr.com/i/BunpMn)

**HTTPS过程:**

HTTPS在传输数据之前需要客户端与服务器进行一个握手(TSL/SSL握手),在握手的过程中将确立对方家里传输数据的密码信息.TLS/SSL使用了非对称加密,对称加密以及hash等.

HTTPS相对于HTTP,虽然提供了安全保证,但势必会造成一些时间上的损耗,如握手和加密等过程,使用前需要做好安全和性能方面的权衡

**HTTP请求:**

http请求主要发生在客户端.发送http请求的过程就是构建HTTP请求报文并通过TCP协议中发送到服务器指定端口(HTTP协议80/8080,HTTPS协议443)
http请求报文由三部分组成

- 请求行 ( 常用方法有get,post,put,delete...等)

- 请求报头(请求报头允许客户端向服务器传递请求的附加信息和客户端自身的信息)

  ![](https://s3.ax1x.com/2020/11/16/DAklNQ.png)

  > 上图是使用Chrome开发者工具截取的对百度的HTTP请求以及响应报文，从图中可以看出，请求报头中使用了Accept, Accept-Encoding, Accept-Language, Cache-Control, Connection, Cookie等字段。Accept用于指定客户端用于接受哪些类型的信息，Accept-Encoding与Accept类似，它用于指定接受的编码方式。Connection设置为Keep-alive用于告诉客户端本次HTTP请求结束之后并不需要关闭TCP连接，这样可以使下次HTTP请求使用相同的TCP通道，节省TCP连接建立的时间。

- 请求正文(客户端向服务端传递的数据)

  > 上图是使用Chrome开发者工具截取的对百度的HTTP请求以及响应报文，从图中可以看出，请求报头中使用了Accept, Accept-Encoding, Accept-Language, Cache-Control, Connection, Cookie等字段。Accept用于指定客户端用于接受哪些类型的信息，Accept-Encoding与Accept类似，它用于指定接受的编码方式。Connection设置为Keep-alive用于告诉客户端本次HTTP请求结束之后并不需要关闭TCP连接，这样可以使下次HTTP请求使用相同的TCP通道，节省TCP连接建立的时间。
### 04 /服务器处理请求并返回HTTP报文
HTTP响应报文也是由三部分组成: **状态码**, **响应报头**和**响应报文**。
**状态码**
状态码是由3位数组成，第一个数字定义了响应的类别，且有五种可能取值:

-	1xx:指示信息 - 表示请求已接收,继续处理
-	2xx:成功 - 表示请求已被成功接收,理解,处理
-	3xx:重定向 -  要完成请求必须进行更进一步的操作
-	4xx:客户端错误 - 请求有语法错误或请求无法实现.
-	5xx:服务端错误 - 服务器未能实现合法请求
**常见错误码:**
-    200:请求成功
-    204:无内容。服务器成功处理，但未返回内容。在未更新网页的情况下，可确保浏览器继续显示当前文档
-    301:永久移动。请求的资源已被永久的重定向到新URI，返回信息会包括新的URI，浏览器会自动定向到新URI。今后任何新的请求都应使用新的URI代替
-    302:临时移动。与301类似。但资源只是临时被移动。客户端应继续使用原有URI
-    304:未修改。所请求的资源未修改，服务器返回此状态码时，不会返回任何资源。客户端通常会缓存访问过的资源，通过提供一个头信息指出客户端希望只返回在指定日期之后修改的资源
-    400:客户端请求的语法错误，服务器无法理解
-    401:请求要求用户的身份认证
-    403:服务器理解请求客户端的请求，但是拒绝执行此请求
-    404:服务器无法根据客户端的请求找到资源（网页）。通过此代码，网站设计人员可设置"您所请求的资源无法找到"的个性页面
-    422:请求格式正确，但是由于含有语义错误，无法响应。
-    500:服务器内部错误，无法完成请求


### 05 /浏览器解析渲染页面

浏览器在收到HTML,CSS,JS文件后，它是如何把页面呈现到屏幕上的？下图对应的就是WebKit渲染的过程。

![](https://s3.ax1x.com/2020/11/16/DAAsIg.png)

浏览器是一个边解析边渲染的过程。

- 首先浏览器解析HTML文件构建DOM树，然后解析CSS文件构建渲染树，等到渲染树构建完成后，浏览器开始布局渲染树并将其绘制到屏幕上。
- 这个过程比较复杂，涉及到两个概念: reflow(回流)和repain(重绘)。DOM节点中的各个元素都是以盒模型的形式存在，这些都需要浏览器去计算其位置和大小等，这个过程称为relow;
- 当盒模型的位置,大小以及其他属性，如颜色,字体,等确定下来之后，浏览器便开始绘制内容，这个过程称为repain。
- 页面在首次加载时必然会经历reflow和repain。reflow和repain过程是非常消耗性能的，尤其是在移动设备上，它会破坏用户体验，有时会造成页面卡顿。所以我们应该尽可能少的减少reflow和repain。

该过程涉及到两个概念 : **重绘**,**回流**

- **回流:**DOM节点中的各个元素都是以盒模型的形式存在,需要浏览器来计算其位置和大小等,该过程叫做回流
- **重绘:**当盒模型的位置,大小以及其他属性,如颜色,字体等确定下来之后,浏览器就开始绘制内容,该过程叫做重绘


