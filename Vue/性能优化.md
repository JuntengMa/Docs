# Vue项目优化之 - 启动时间优化

### 1、speed-measure-webpack-plugin

- 用于测试打包各阶段的loader以及plugin的工作花费的时间。

  <img src="https://gitee.com/JuntengMa/imgae/raw/master/image-20211028144222857.png" alt="image-20211028144222857" style="zoom:50%; float:left" />

- 安装

  ```
  npm i speed-measure-webpack-plugin -D
  ```

- 使用

  Vue-cli 2.x 中如下

  ```
  //webpack.config.js
  const SpeedMeasurePlugin = require("speed-measure-webpack-plugin");
  const smp = new SpeedMeasurePlugin();
  
  const config = {
      //...webpack配置
  }
  
  module.exports = smp.wrap(config);
  ```

  Vue-cli 3.x 中如下（主要区别是包裹 configureWebpack ）

  ```
  const SpeedMeasurePlugin = require('speed-measure-webpack-plugin')
  const smp = new SpeedMeasurePlugin({
    outputFormat: 'human'
  })
  module.exports = {
    configureWebpack: smp.wrap({
      plugins: []
    })
  }
  ```

  

### 2、webpack-bundle-analyzer

- 这个是分析打包后，各个文件的大小，用于分析 bundle 的

<img src="https://gitee.com/JuntengMa/imgae/raw/master/image-20211028145219287.png" alt="image-20211028145219287" style="zoom:50%;" />

- 安装

  ```
  npm i webpack-bundle-analyzer -D
  ```

- 使用

  ```js
  const BundleAnalyzerPlugin =
    require("webpack-bundle-analyzer").BundleAnalyzerPlugin;
  
  // chainWebpack
  // 生产环境做的一些处理
  config.when(process.env.NODE_ENV === "production", (config) => {
    // 配置打包分析工具 ， 配合 ` npm run analyze 命令使用`
    if (process.env.use_analyzer) {
      config.plugin("webpack-report").use(BundleAnalyzerPlugin);
    }
  }
  ```

- 配置scripts

  // package.json , 注意 build：ci 需要改为项目对应的build命令

  ```
   "analyze": "cross-env NODE_ENV=production use_analyzer=true npm run build:ci",
  ```

  

### 3、分析 & 解决方案

从时间测试图来看，vue-loader、babel-loader都是三十多秒，从bundle图可以知道页面较多，vue-loader压力较大

**解决方案：缓存** （[hard-source-webpack-plugin](https://www.npmjs.com/package/hard-source-webpack-plugin)）

> `HardSourceWebpackPlugin`是 webpack 的插件，为模块提供中间缓存步骤。为了查看结果，您需要使用此插件运行 webpack 两次：第一次构建将花费正常的时间。第二个构建将显着更快。

- 安装

  ```
  npm i -D hard-source-webpack-plugin
  ```

- 使用

  ```js
   chainWebpack(config) {
   		...
      config.plugin("cache").use(HardSourceWebpackPlugin);
   },
  ```

- 测试&效果
	构建时间，经过测试 2 ~ 8 秒以内，只能说 😳😱😆🤣😁 ohhhhhhh！！！！

  | 首次构建                                                     | 第二&三次构建                                                |
  | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | <img src="https://gitee.com/JuntengMa/imgae/raw/master/image-20211028144222857.png" alt="image-20211028144222857" style="zoom:50%; float:left;border-radius: 20px;" /> | <img src="https://gitee.com/JuntengMa/imgae/raw/master/image-20211028151554138.png" alt="image-20211028151554138" style="zoom: 47%; border-radius: 20px;" /> |


- 关于缓存的位置：

  <img src="https://gitee.com/JuntengMa/imgae/raw/master/image-20211028152230284.png" alt="image-20211028152230284" style="zoom:50%;border-radius:20px;float:left" />
  
  

